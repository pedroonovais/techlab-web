# üß™ TechLab ‚Äî Sistema de Gerenciamento de P√°tios, IoT e Motos

Aplica√ß√£o **web** (Thymeleaf) e **API REST** constru√≠da em **Spring Boot 3** para administrar p√°tios, dispositivos **IoT** e **motos**, com autentica√ß√£o (OAuth2 + formul√°rio + JWT), **dashboard** com KPIs e UI dark usando **TailwindCSS** (CDN).

---

## üë• Integrantes

- **Davi Alves de Lima** ‚Äî RM 556008  
- **Pedro Henrique Mendon√ßa de Novais** ‚Äî RM 555276  
- **Rodrigo Alcides Bohac R√≠os** ‚Äî RM 554826  

---

## üì¶ Estrutura do Projeto

- **Build**: Gradle (Java 17)  
- **Main class**: `com.techlab.Application`  
- **View engine**: Thymeleaf  
- **UI**: TailwindCSS via CDN (ver `templates/fragments/header.html`)  
- **Banco**: Oracle Database (Flyway para migra√ß√µes)  
- **Auth**: Spring Security (Form login + OAuth2 GitHub/Google + JWT para API REST)  

### Pacotes principais (em `src/main/java/com/techlab/`):

```
config/                 # Configura√ß√µes (SecurityConfiguration, JwtAuthenticationFilter, RestExceptionHandler)
dashboard/              # Dashboard com KPIs (DashboardController)
iot/                    # CRUD de IoT (Iot, IotController, IotRestController, IotRepository, IotService, IotDTO)
moto/                   # CRUD de Moto (Moto, MotoController, MotoRepository, MotoService, MotoDTO)
patio/                  # CRUD de P√°tio (Patio, PatioController, PatioRepository, PatioService, PatioDTO)
auth/                   # Autentica√ß√£o (AuthController, AuthRestController, JwtService, LoginForm, RegisterForm)
user/                   # Gerenciamento de usu√°rios (User, UserController, UserService, UserDetailsServiceImpl)
helper/                # Classes base e utilit√°rios (BaseController, BaseService)
debug/                  # Endpoints de debug (DebugController)
```

**Templates** (em `src/main/resources/templates/`): `index.html`, `login.html`, `logout.html`, `register.html`, pastas `patio/`, `iot/`, `moto/`, `fragments/` (header, footer), etc.

**Migra√ß√µes Flyway** (em `src/main/resources/db/migration/`): 
- `V1__create_table_user.sql` ‚Äî Tabela de usu√°rios
- `V2__create_table_patio.sql` ‚Äî Tabela de p√°tios
- `V3__create_table_iot.sql` ‚Äî Tabela de dispositivos IoT
- `V4__create_table_moto.sql` ‚Äî Tabela de motos com relacionamentos

**Migra√ß√µes de desenvolvimento** (em `src/main/resources/db/migration-dev/`): Dados iniciais para testes.

---

## üîß Tecnologias

- **Spring Boot 3.5.4**
- Spring MVC, Spring Security, Spring Data JPA
- **Thymeleaf** (templates web)
- **TailwindCSS** (CDN)
- **Oracle Database** + **Flyway** (migra√ß√µes)
- **JWT** (JSON Web Tokens) para autentica√ß√£o de API REST
- **Lombok** (redu√ß√£o de boilerplate)
- **Docker** (Dockerfile e compose.yaml)
- **Gradle** (build tool)

---

## üöÄ Como Rodar

### Pr√©‚Äërequisitos
- **Java 17+**
- **Oracle Database** acess√≠vel (local ou remoto)
- **Gradle** (wrapper incluso: `./gradlew` ou `gradlew.bat`)

### 1) Configurar Banco de Dados

O projeto est√° configurado para usar **Oracle Database**. No modo de desenvolvimento, a aplica√ß√£o usa as credenciais configuradas em `application.properties`:

```properties
spring.datasource.url=jdbc:oracle:thin:@oracle.fiap.com.br:1521:orcl
spring.datasource.username=rmXXXXXX
spring.datasource.password=000000
```

Para produ√ß√£o, configure as vari√°veis de ambiente:

```bash
DB_URL=jdbc:oracle:thin:@seu-host:1521:orcl
DB_USER=seu_usuario
DB_PASS=sua_senha
```

### 2) Configurar vari√°veis de ambiente (opcional para OAuth2)

Para habilitar OAuth2 (GitHub/Google), configure as seguintes vari√°veis:

```bash
# OAuth2 (opcional)
GITHUB_CLIENT_ID=xxxxx
GITHUB_CLIENT_SECRET=xxxxx
GOOGLE_CLIENT_ID=xxxxx
GOOGLE_CLIENT_SECRET=xxxxx

# Perfil ativo (padr√£o: dev)
ACTIVE_PROFILE=dev  # ou 'prod' para produ√ß√£o
```

> O perfil ativo √© definido por `ACTIVE_PROFILE` (padr√£o: `dev`). No `dev` as migra√ß√µes do Flyway s√£o procuradas em `classpath:db/migration,classpath:db/migration-dev` (ver `application.properties`).

### 3) Subir a aplica√ß√£o

```bash
# Linux/Mac
./gradlew bootRun

# Windows
gradlew.bat bootRun
```

Acesse **http://localhost:8080**.

### 4) Build de JAR

```bash
./gradlew bootJar
java -jar build/libs/*.jar
```

### 5) Docker (opcional)

Uma imagem pode ser gerada usando o `Dockerfile` incluso:

```bash
docker build -t techlab:latest .
docker run -p 8080:8080 --name techlab \
  -e ACTIVE_PROFILE=prod \
  -e DB_URL=jdbc:oracle:thin:@host.docker.internal:1521:orcl \
  -e DB_USER=seu_usuario \
  -e DB_PASS=sua_senha \
  techlab:latest
```

### 6) Docker Compose (PostgreSQL para desenvolvimento local)

O projeto inclui um `compose.yaml` com PostgreSQL para desenvolvimento local:

```bash
docker-compose up -d
```

---

## üóÇÔ∏è Banco de Dados (Modelo de Dados)

### Tabelas principais:

```sql
-- Usu√°rios
CREATE TABLE techlabuser (
    id         NUMBER(19) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    email      VARCHAR2(255) UNIQUE NOT NULL,
    name       VARCHAR2(255),
    avatar_url VARCHAR2(255),
    password   VARCHAR2(255)
);

-- P√°tios
CREATE TABLE patio (
    id   NUMBER(19) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nome VARCHAR2(255) NOT NULL UNIQUE
);

-- Dispositivos IoT
CREATE TABLE iot (
    id           NUMBER(19) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ativo        NUMBER(1) NOT NULL,
    bateria      NUMBER(10),
    coordenada_x VARCHAR2(255) NOT NULL,
    coordenada_y VARCHAR2(255) NOT NULL
);

-- Motos (com relacionamentos)
CREATE TABLE moto (
    id           NUMBER(19) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    modelo       VARCHAR2(255) NOT NULL,
    placa        VARCHAR2(255) NOT NULL UNIQUE,
    data_entrada TIMESTAMP NOT NULL,
    data_saida   TIMESTAMP,
    iot_id       NUMBER(19),
    patio_id     NUMBER(19),
    CONSTRAINT fk_moto_iot FOREIGN KEY (iot_id) REFERENCES iot(id),
    CONSTRAINT fk_moto_patio FOREIGN KEY (patio_id) REFERENCES patio(id)
);
```

### Relacionamentos:

- **Moto** ‚Üí **IoT** (Many-to-One): Uma moto pode ter um dispositivo IoT associado
- **Moto** ‚Üí **Patio** (Many-to-One): Uma moto est√° em um p√°tio

> Observa√ß√£o: O dom√≠nio **n√£o** utiliza mais "Setor". IoT, Moto e P√°tio s√£o gerenciados de forma independente, com relacionamentos opcionais entre Moto e IoT/Patio.

---

## üåê Rotas Principais

### Autentica√ß√£o Web

- `GET /login` ‚Äî p√°gina de login  
- `GET /register` ‚Äî cadastro de usu√°rio  
- `POST /register` ‚Äî cria o usu√°rio  
- `POST /logout` ‚Äî encerra sess√£o  
- OAuth2: `GET /oauth2/authorization/github` e `GET /oauth2/authorization/google`

### API REST (JSON)

#### Autentica√ß√£o
- `POST /api/auth/login` ‚Äî Login via API retornando token JWT
  ```json
  {
    "email": "usuario@example.com",
    "password": "senha123"
  }
  ```
  Resposta:
  ```json
  {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
  ```

#### Dispositivos IoT
- `PUT /api/iot/{id}` ‚Äî Atualiza um dispositivo IoT (requer autentica√ß√£o JWT)
  ```json
  {
    "ativo": true,
    "bateria": 85,
    "coordenadaX": "10.5",
    "coordenadaY": "20.3"
  }
  ```

#### Usu√°rio
- `GET /api/user` ‚Äî Retorna dados do usu√°rio autenticado

### Dashboard

- `GET /` ‚Äî redirect para `/index`
- `GET /index` ‚Äî Dashboard com KPIs:
  - Total de P√°tios
  - Total de IoTs (ativos/inativos)
  - Total de Motos
  - M√©dia de bateria dos dispositivos IoT
  - Distribui√ß√£o de bateria por faixas (0-20, 21-40, 41-60, 61-80, 81-100)

### P√°tio (Web)

- `GET /patio` ‚Äî listar p√°tios
- `GET /patio/form` ‚Äî formul√°rio de cria√ß√£o
- `POST /patio/form` ‚Äî criar/atualizar (envia `id` para editar)
- `GET /patio/{id}/edit` ‚Äî editar p√°tio
- `POST /patio/{id}/delete` ‚Äî excluir p√°tio

### IoT (Web)

- `GET /iot` ‚Äî listar dispositivos IoT
- `GET /iot/form` ‚Äî formul√°rio de cria√ß√£o
- `POST /iot/form` ‚Äî criar/atualizar
- `GET /iot/{id}/edit` ‚Äî editar dispositivo
- `POST /iot/{id}/delete` ‚Äî excluir dispositivo

### Moto (Web)

- `GET /moto` ‚Äî listar motos
- `GET /moto/form` ‚Äî formul√°rio de cria√ß√£o
- `POST /moto/form` ‚Äî criar/atualizar
- `GET /moto/{id}/edit` ‚Äî editar moto
- `POST /moto/{id}/delete` ‚Äî excluir moto

### Debug

- `GET /debug/test-user-creation` ‚Äî Testa cria√ß√£o de usu√°rio
- `GET /debug/check-user` ‚Äî Verifica usu√°rio existente

---

## üé® UI / Padr√£o Visual

- Tema **dark** com **TailwindCSS** via CDN (Inter como font)  
- Componentiza√ß√£o de **navbar** e **footer** em `templates/fragments/`  
- P√°ginas seguem o padr√£o: **bgs** `gray-900/800`, **borders** `gray-700`, **prim√°rias** `green-600/700`, **destaques** `cyan-500`  
- Interface responsiva e moderna

---

## üîê Seguran√ßa

### Autentica√ß√£o Web

- Spring Security com **form login** e **OAuth2** (GitHub/Google).  
- `SecurityConfiguration` define regras p√∫blicas/privadas e provedor com **BCrypt**.  
- CSRF habilitado e utilizado nos formul√°rios (`_csrf`).

### Autentica√ß√£o API REST

- **JWT (JSON Web Tokens)** para autentica√ß√£o de API REST
- Filtro `JwtAuthenticationFilter` valida tokens JWT nas requisi√ß√µes `/api/**`
- Endpoint `/api/auth/login` retorna token JWT ap√≥s autentica√ß√£o bem-sucedida
- Tokens devem ser enviados no header: `Authorization: Bearer <token>`

### Rotas P√∫blicas

- `/login`, `/register`, `/debug/**`, `/css/**`, `/js/**`, `/images/**`
- `/api/auth/login` (endpoint de login da API)

### Rotas Protegidas

- Todas as outras rotas requerem autentica√ß√£o (web ou JWT)

---

## üìä Dashboard e KPIs

O dashboard (`/index`) exibe:

- **Total de P√°tios**: Contagem total de p√°tios cadastrados
- **Total de IoTs**: Contagem total de dispositivos IoT
- **IoTs Ativos**: Quantidade de dispositivos IoT ativos
- **IoTs Inativos**: Quantidade de dispositivos IoT inativos
- **Total de Motos**: Contagem total de motos cadastradas
- **M√©dia de Bateria**: M√©dia da bateria de todos os dispositivos IoT
- **Distribui√ß√£o de Bateria**: Contagem de dispositivos por faixa de bateria:
  - 0-20%
  - 21-40%
  - 41-60%
  - 61-80%
  - 81-100%

---

## üìÑ Licen√ßa

Projeto acad√™mico ‚Äî FIAP. Uso educacional.
